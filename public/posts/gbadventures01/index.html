<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>Adventures in aggregation: Part 1 | Aaron&#39;s D4ta blog</title>
<meta name="keywords" content="">
<meta name="description" content="It&rsquo;s impossible to include an associated field value alongside an aggregate of another variable The mind sometimes has a way of creating a sensible objective that is non-sensical to a machine. We want to tabulate the make of the most expensive car in teh same row as its price. When you use the .agg method with a dictionary, you can end up with misaligned columns
df = pd.DataFrame({&#39;Sector&#39;: [&#39;auto&#39;, &#39;auto&#39;, &#39;auto&#39;], &#39;c&#39;: [&#39;ACME&#39;, &#39;GM&#39;, &#39;FORD&#39;], &#39;am&#39;: [20.">
<meta name="author" content="Aaron Slowey">
<link rel="canonical" href="https://drwaterx.github.io/til/posts/gbadventures01/">
<link crossorigin="anonymous" href="/til/assets/css/stylesheet.bccfefac377bc340f06c260aed1bddf49a4354816d7c570d6aac75a997986c95.css" integrity="sha256-vM/vrDd7w0DwbCYK7Rvd9JpDVIFtfFcNaqx1qZeYbJU=" rel="preload stylesheet" as="style">
<script defer crossorigin="anonymous" src="/til/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js" integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG&#43;9vmJ0cTS&#43;ovo0FeA="
    onload="hljs.initHighlightingOnLoad();"></script>
<link rel="icon" href="https://drwaterx.github.io/til/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://drwaterx.github.io/til/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://drwaterx.github.io/til/favicon-32x32.png">
<link rel="apple-touch-icon" href="https://drwaterx.github.io/til/apple-touch-icon.png">
<link rel="mask-icon" href="https://drwaterx.github.io/til/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --hljs-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript><meta property="og:title" content="Adventures in aggregation: Part 1" />
<meta property="og:description" content="It&rsquo;s impossible to include an associated field value alongside an aggregate of another variable The mind sometimes has a way of creating a sensible objective that is non-sensical to a machine. We want to tabulate the make of the most expensive car in teh same row as its price. When you use the .agg method with a dictionary, you can end up with misaligned columns
df = pd.DataFrame({&#39;Sector&#39;: [&#39;auto&#39;, &#39;auto&#39;, &#39;auto&#39;], &#39;c&#39;: [&#39;ACME&#39;, &#39;GM&#39;, &#39;FORD&#39;], &#39;am&#39;: [20." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://drwaterx.github.io/til/posts/gbadventures01/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-08-12T15:14:44-05:00" />
<meta property="article:modified_time" content="2022-08-12T15:14:44-05:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Adventures in aggregation: Part 1"/>
<meta name="twitter:description" content="It&rsquo;s impossible to include an associated field value alongside an aggregate of another variable The mind sometimes has a way of creating a sensible objective that is non-sensical to a machine. We want to tabulate the make of the most expensive car in teh same row as its price. When you use the .agg method with a dictionary, you can end up with misaligned columns
df = pd.DataFrame({&#39;Sector&#39;: [&#39;auto&#39;, &#39;auto&#39;, &#39;auto&#39;], &#39;c&#39;: [&#39;ACME&#39;, &#39;GM&#39;, &#39;FORD&#39;], &#39;am&#39;: [20."/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Posts",
      "item": "https://drwaterx.github.io/til/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "Adventures in aggregation: Part 1",
      "item": "https://drwaterx.github.io/til/posts/gbadventures01/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Adventures in aggregation: Part 1",
  "name": "Adventures in aggregation: Part 1",
  "description": "It\u0026rsquo;s impossible to include an associated field value alongside an aggregate of another variable The mind sometimes has a way of creating a sensible objective that is non-sensical to a machine. We want to tabulate the make of the most expensive car in teh same row as its price. When you use the .agg method with a dictionary, you can end up with misaligned columns\ndf = pd.DataFrame({\u0026#39;Sector\u0026#39;: [\u0026#39;auto\u0026#39;, \u0026#39;auto\u0026#39;, \u0026#39;auto\u0026#39;], \u0026#39;c\u0026#39;: [\u0026#39;ACME\u0026#39;, \u0026#39;GM\u0026#39;, \u0026#39;FORD\u0026#39;], \u0026#39;am\u0026#39;: [20.",
  "keywords": [
    
  ],
  "articleBody": "It’s impossible to include an associated field value alongside an aggregate of another variable The mind sometimes has a way of creating a sensible objective that is non-sensical to a machine. We want to tabulate the make of the most expensive car in teh same row as its price. When you use the .agg method with a dictionary, you can end up with misaligned columns\ndf = pd.DataFrame({'Sector': ['auto', 'auto', 'auto'], 'c': ['ACME', 'GM', 'FORD'], 'am': [20.5, 900.10, 450.50]}) \u003e\u003e\u003e df.groupby('Sector').agg({'c': 'first', 'am': 'max'}) ![[Pasted image 20220928143130.png]]\nNote that the first company name was selected, as was the maximum amount; but ACME is not associated with $900.10!\nAs discovered in the more complicated example below, the grouping variable will replace any index, so we cannot simply set or add 'c' to the index and then groupby.\nIt’s possible to have the first instance of one field alongside a summary of a variable, but they may be associated with different records. If the dataframe is sorted descending, .agg('first') will align with 'max'; if sorted ascending, 'first' aligns with 'min'. But a quantile will not align to first or last; nth could be determined by locating the quantile value, as long as np.quantile outputs an observed value and not an interpolation, which it may do by default. Alternatively, merge tables on the quantile, again with NumPy instructed to output the observation nearest ’true’ quantile. To do that, use interpolation='nearest'.\ndef sector_quantilians(data: pd.DataFrame, quantile: float, group_field: str = 'Sector', metric: str = 'AMOUNT' ): print(f\"{quantile:%}-ile of {metric} for {group_field}\") return data.groupby(group_field, observed=True)[metric].apply( lambda x: np.quantile(x, quantile, interpolation='nearest')) ",
  "wordCount" : "264",
  "inLanguage": "en",
  "datePublished": "2022-08-12T15:14:44-05:00",
  "dateModified": "2022-08-12T15:14:44-05:00",
  "author":{
    "@type": "Person",
    "name": "Aaron Slowey"
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://drwaterx.github.io/til/posts/gbadventures01/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Aaron's D4ta blog",
    "logo": {
      "@type": "ImageObject",
      "url": "https://drwaterx.github.io/til/favicon.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://drwaterx.github.io/til/" accesskey="h" title="Aaron&#39;s D4ta blog (Alt + H)">Aaron&#39;s D4ta blog</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://drwaterx.github.io/til/about/" title="About">
                    <span>About</span>
                </a>
            </li>
            <li>
                <a href="https://drwaterx.github.io/til/archives" title="Archive">
                    <span>Archive</span>
                </a>
            </li>
            <li>
                <a href="https://drwaterx.github.io/til/tags" title="Tags">
                    <span>Tags</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    
    <h1 class="post-title">
      Adventures in aggregation: Part 1
    </h1>
    <div class="post-meta"><span title='2022-08-12 15:14:44 -0500 -0500'>August 12, 2022</span>&nbsp;·&nbsp;Aaron Slowey

</div>
  </header> 
  <div class="post-content"><h1 id="its-impossible-to-include-an-_associated_-field-value-alongside-an-aggregate-of-another-variable">It&rsquo;s impossible to include an <em>associated</em> field value alongside an aggregate of another variable<a hidden class="anchor" aria-hidden="true" href="#its-impossible-to-include-an-_associated_-field-value-alongside-an-aggregate-of-another-variable">#</a></h1>
<p>The mind sometimes has a way of creating a sensible objective that is non-sensical to a machine.  We want to tabulate the make of the most expensive car in teh same row as its price.  When you use the <code>.agg</code> method with a dictionary, you can end up with misaligned columns</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>df <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>DataFrame({<span style="color:#e6db74">&#39;Sector&#39;</span>: [<span style="color:#e6db74">&#39;auto&#39;</span>, <span style="color:#e6db74">&#39;auto&#39;</span>, <span style="color:#e6db74">&#39;auto&#39;</span>],
</span></span><span style="display:flex;"><span>                   <span style="color:#e6db74">&#39;c&#39;</span>: [<span style="color:#e6db74">&#39;ACME&#39;</span>, <span style="color:#e6db74">&#39;GM&#39;</span>, <span style="color:#e6db74">&#39;FORD&#39;</span>],
</span></span><span style="display:flex;"><span>                   <span style="color:#e6db74">&#39;am&#39;</span>: [<span style="color:#ae81ff">20.5</span>, <span style="color:#ae81ff">900.10</span>, <span style="color:#ae81ff">450.50</span>]})
</span></span><span style="display:flex;"><span>                   
</span></span><span style="display:flex;"><span><span style="color:#f92672">&gt;&gt;&gt;</span> df<span style="color:#f92672">.</span>groupby(<span style="color:#e6db74">&#39;Sector&#39;</span>)<span style="color:#f92672">.</span>agg({<span style="color:#e6db74">&#39;c&#39;</span>: <span style="color:#e6db74">&#39;first&#39;</span>, <span style="color:#e6db74">&#39;am&#39;</span>: <span style="color:#e6db74">&#39;max&#39;</span>})
</span></span></code></pre></div><p>![[Pasted image 20220928143130.png]]</p>
<p>Note that the first company name was selected, as was the maximum amount; but ACME is not associated with $900.10!</p>
<p>As discovered in the more complicated example below, the grouping variable will replace any index, so we cannot simply set or add <code>'c'</code> to the index and then groupby.</p>
<p>It&rsquo;s possible to have the first instance of one field alongside a summary of a variable, but they may be associated with different records.  If the dataframe is sorted descending, <code>.agg('first')</code> will align with <code>'max'</code>; if sorted ascending, <code>'first'</code> aligns with <code>'min'</code>.  But a quantile will not align to <code>first</code> or <code>last</code>; <code>nth</code> could be determined by locating the quantile value, as long as <code>np.quantile</code> outputs an observed value and not an interpolation, which it may do by default.  Alternatively, merge tables on the quantile, again with NumPy instructed to output the observation nearest &rsquo;true&rsquo; quantile.  To do that, use <code>interpolation='nearest'</code>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">sector_quantilians</span>(data: pd<span style="color:#f92672">.</span>DataFrame,
</span></span><span style="display:flex;"><span>                       quantile: float,
</span></span><span style="display:flex;"><span>                       group_field: str <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;Sector&#39;</span>,
</span></span><span style="display:flex;"><span>                       metric: str <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;AMOUNT&#39;</span>
</span></span><span style="display:flex;"><span>                      ):
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">{</span>quantile<span style="color:#e6db74">:</span><span style="color:#e6db74">%</span><span style="color:#e6db74">}</span><span style="color:#e6db74">-ile of </span><span style="color:#e6db74">{</span>metric<span style="color:#e6db74">}</span><span style="color:#e6db74"> for </span><span style="color:#e6db74">{</span>group_field<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> data<span style="color:#f92672">.</span>groupby(group_field, observed<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)[metric]<span style="color:#f92672">.</span>apply(
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">lambda</span> x: np<span style="color:#f92672">.</span>quantile(x, quantile, interpolation<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;nearest&#39;</span>))
</span></span></code></pre></div>

  </div>

  <footer class="post-footer">
    <ul class="post-tags">
    </ul>
  </footer>
</article>
    </main>
    
<footer class="footer">
    <span>&copy; 2023 <a href="https://drwaterx.github.io/til/">Aaron&#39;s D4ta blog</a></span>
    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
</body>

</html>
